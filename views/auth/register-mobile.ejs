<%- include('../bootstrap/header') %>
<style>
  .toggle-password {
    width: 42px; /* fixed width */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0; /* remove extra padding */
  }
</style>
<div class="container p-3">
  <h4 class="text-center fw-bold mb-4">Create a New Account</h4>
  <!-- Error Alert -->
  <% if (typeof error !== 'undefined' && error) { %>
    <div class="alert alert-danger" role="alert">
        <%= error %>
    </div>
  <% } %>
  <!-- Register Form -->
  <form action="/auth/register" method="POST">
    <div class="row g-3">
      <div class="col-6">
        <label for="firstname" class="form-label fw-bold">First Name <span class="text-danger">*</span></label>
        <input type="text" id="firstname" name="first_name" class="form-control" placeholder="First Name" required>
      </div>
      <div class="col-6">
        <label for="lastname" class="form-label fw-bold">Last Name <span class="text-danger">*</span></label>
        <input type="text" id="lastname" name="last_name" class="form-control" placeholder="Last Name" required>
      </div>
      <div class="col-12">
        <label for="email" class="form-label fw-bold">Email address <span class="text-danger">*</span></label>
        <input type="email" id="email" name="email" class="form-control" placeholder="Email address" required>
      </div>
      <div class="col-12">
        <label for="username" class="form-label fw-bold">Username <span class="text-danger">*</span></label>
        <div class="input-group">
          <input type="text" id="username" name="username" class="form-control" placeholder="Username" required>
          <label class="input-group-text" id="username-status">
            <i class="fa fa-spinner fa-spin d-none"></i>
            <i class="fa fa-check text-success d-none"></i>
            <i class="fa fa-times text-danger d-none"></i>
          </label>
        </div>
        <small id="usernameHelp" class="form-text"></small>
      </div>
      <div class="col-12">
        <label for="password" class="form-label fw-bold">Password <span class="text-danger">*</span></label>
        <div class="input-group">
          <input type="password" id="password" name="password" class="form-control" placeholder="At least 8 characters" minlength="8" required>
          <button type="button" class="input-group-text toggle-password">
            <i class="fa fa-eye"></i>
          </button>
        </div>
        <small class="form-text text-muted">Use at least 8 characters.</small>
      </div>
      <div class="col-6">
        <label for="dob" class="form-label fw-bold">Date of Birth <span class="text-danger">*</span></label>
        <input type="date" name="dob" id="dob" class="form-control" required>
      </div>
      <div class="col-6">
        <label for="gender" class="form-label fw-bold">Gender <span class="text-danger">*</span></label>
        <select name="gender" id="gender" class="form-select" required>
          <option value="" disabled selected>Select Gender</option>
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other</option>
        </select>
      </div>
      <!-- Terms and Conditions Checkbox -->
      <div class="col-12">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="" id="agreeTerms" name="agreeTerms" required>
          <label class="form-check-label" for="agreeTerms">
            I agree to the <a href="/terms-conditions" class="text-decoration-none" target="_blank">Terms & Conditions</a> and <a href="/privacy-policy" class="text-decoration-none" target="_blank">Privacy Policy</a> <span class="text-danger">*</span>
          </label>
          <div class="invalid-feedback">
            You must agree to the Terms & Conditions and Privacy Policy before registering.
          </div>
        </div>
      </div>
      <div class="col-12">
        <button type="submit" id="submitBtn" class="btn btn-dark w-100" disabled>Sign Up</button>
      </div>
      <div class="col-12 border-top pt-3">
        <a href="/auth/login" class="btn btn-light w-100">Already have an account? Log In</a>
      </div>
    </div>
  </form>
  <p class="text-center text-muted mt-3 small">
    &copy; 2025 Pethudl. All rights reserved.
  </p>
</div>

<script>
  const togglePassword = document.querySelector(".toggle-password");
  const password = document.querySelector("#password");
  const agreeTermsCheckbox = document.querySelector("#agreeTerms");
  const submitBtn = document.querySelector("#submitBtn");
  
  // Password toggle functionality
  togglePassword.addEventListener("click", function () {
    // toggle type attribute
    const type = password.getAttribute("type") === "password" ? "text" : "password";
    password.setAttribute("type", type);
    // toggle the icon
    const icon = this.querySelector("i");
    icon.classList.toggle("fa-eye");
    icon.classList.toggle("fa-eye-slash");
  });
  
  // Enable/disable submit button based on checkbox state
  agreeTermsCheckbox.addEventListener("change", function () {
    if (this.checked) {
      submitBtn.disabled = false;
    } else {
      submitBtn.disabled = true;
    }
  });
</script>

<script>
const usernameInput = document.querySelector("#username");
const spinner = document.querySelector("#username-status .fa-spinner");
const checkIcon = document.querySelector("#username-status .fa-check");
const crossIcon = document.querySelector("#username-status .fa-times");
const usernameHelp = document.querySelector("#usernameHelp");

let timeout = null;

usernameInput.addEventListener("input", function () {
  clearTimeout(timeout);

  const username = this.value.trim();
  if (username.length < 3) {
    spinner.classList.add("d-none");
    checkIcon.classList.add("d-none");
    crossIcon.classList.add("d-none");
    usernameHelp.textContent = "Username must be at least 3 characters.";
    return;
  }

  spinner.classList.remove("d-none");
  checkIcon.classList.add("d-none");
  crossIcon.classList.add("d-none");
  usernameHelp.textContent = "Checking...";

  timeout = setTimeout(async () => {
    try {
      const res = await fetch(`/auth/check-username?username=${encodeURIComponent(username)}`);
      const data = await res.json();

      spinner.classList.add("d-none");

      if (data.available) {
        checkIcon.classList.remove("d-none");
        crossIcon.classList.add("d-none");
        usernameHelp.textContent = data.message;
        usernameHelp.classList.remove("text-danger");
        usernameHelp.classList.add("text-success");
      } else {
        checkIcon.classList.add("d-none");
        crossIcon.classList.remove("d-none");
        usernameHelp.textContent = data.message;
        usernameHelp.classList.remove("text-success");
        usernameHelp.classList.add("text-danger");
      }
    } catch (err) {
      spinner.classList.add("d-none");
      crossIcon.classList.remove("d-none");
      usernameHelp.textContent = "Error checking username.";
    }
  }, 500); // debounce delay
});
</script>
