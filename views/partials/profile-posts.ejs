<% if (posts && posts.length > 0) { %>
  <% posts.forEach(post => { %>
    <!-- Post Card -->
    <div class="card border-0 shadow-sm mb-3 postCard" data-post-id="<%= post.id %>">
      <div class="card-body p-3 p-sm-4">
        
        <!-- User Info Header -->
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="d-flex align-items-center">
            <a href="/@<%- post.username %>">
              <img src="<%- post.profile_pic || '/images/paw.jpg' %>" class="rounded-circle border me-2" style="width:40px; height:40px; object-fit:cover;">
            </a>
            <div class="d-flex flex-column">
              <a href="/@<%- post.username %>" class="text-decoration-none text-dark fw-bold mb-0">
                <!-- <%= profileUser.first_name %> <%= profileUser.last_name %> -->
                @<%- profileUser.username %>
              </a>
              <a href="/posts/view-post/<%- post.id %>" class="text-decoration-none text-muted small">
                <%= post.created_at ? new Date(post.created_at).toLocaleString() : 'Just now' %>
              </a>
            </div>
          </div>
          
          <!-- Post Options Dropdown -->
          <div class="d-flex">
            <a class="btn btn-sm btn-light rounded-circle" 
               href="#" 
               role="button" 
               data-bs-toggle="dropdown" 
               aria-expanded="false" 
               style="height:30px;width:30px;border:none;">
              <i class="fa fa-ellipsis"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <% if (user.id === profileUser.id) { %>
                <li>
                  <a class="dropdown-item delete-post-btn" 
                    href="/posts/delete/<%- post.id %>" 
                    data-post-id="<%- post.id %>">
                    <i class="fa fa-trash me-2"></i> Delete Post
                  </a>
                </li>
              <% } %>
            </ul>
          </div>
        </div>

        <!-- Post Content -->
        <p><%= post.content %></p>

        <!-- Media Section -->
        <% if (post.media && post.media.length > 0) { %>
          <div class="mb-2 post-media-grid <%= post.media.length === 1 ? 'single' : '' %>">
            <% post.media.forEach(url => { %>
              <% if(url.match(/\.(mp4|mov|avi)$/i)) { %>
                <div class="post-media-item">
                  <video src="<%= url %>" controls playsinline preload="metadata"></video>
                </div>
              <% } else { %>
                <div class="post-media-item">
                  <img src="<%= url %>" class="img-fluid" alt="Post media">
                </div>
              <% } %>
            <% }) %>
          </div>
        <% } %>

        <!-- Post Stats -->
        <div class="d-flex justify-content-between align-items-center mt-3 border-top border-bottom pt-2 pb-2">
          <span class="text-muted small likes-count"><%= post.likes || 0 %> Likes</span>
          <span class="text-muted small comment-count"><%= (post.comments && Array.isArray(post.comments) ? post.comments.length : post.commentCount) || 0 %> Comments</span>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between gap-2 mt-3">
          <button class="btn btn-light btn-sm like-btn flex-fill">
            <i class="<%= post.is_liked ? 'fas text-primary' : 'far' %> fa-thumbs-up me-2"></i> Like
          </button>
          <button class="btn btn-light btn-sm comment-btn flex-fill" 
                  data-bs-toggle="modal" 
                  data-bs-target="#commentModal-<%= post.id %>">
            <i class="far fa-comment me-2"></i> Comment
          </button>
          <button class="btn btn-light btn-sm flex-fill" data-bs-toggle="modal" 
        data-bs-target="#shareModal-<%= post.id %>">
            <i class="fas fa-share me-2"></i> Share
          </button>
        </div>
      </div>
    </div>

    <!-- Comment Modal (fullscreen on mobile) -->
    <div class="modal fade" id="commentModal-<%= post.id %>" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg modal-fullscreen-sm-down">
        <div class="modal-content">
          
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title">Comments</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <!-- Modal Body -->
          <div class="modal-body">
            <!-- Comments List -->
            <div class="comments-list" id="comments-list-<%= post.id %>">
              <p class="text-muted">Loading comments...</p>
            </div>

            <!-- Add Comment Form -->
            <form class="add-comment-form mt-3 d-flex gap-2 flex-nowrap" data-post-id="<%= post.id %>">
              <input type="text" name="comment" class="form-control flex-grow-1" placeholder="Write a comment..." required>
              <button class="btn btn-dark flex-shrink-0 px-3" type="submit">Post</button>
            </form>
          </div>
        </div>
      </div>
    </div>

<!-- Share Modal (fullscreen on mobile) -->
<div class="modal fade" id="shareModal-<%= post.id %>" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
    <div class="modal-content shadow-lg rounded-3 border-0">

      <!-- Header -->
      <div class="modal-header border-0 pb-0">
        <h5 class="modal-title fw-bold text-primary">
          <i class="fas fa-share-alt me-2"></i> Share This Post
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <!-- Body -->
      <div class="modal-body">

        <!-- Post Link -->
        <div class="mb-3">
          <label class="form-label fw-semibold small text-secondary">Direct Post Link</label>
          <div class="input-group">
            <input type="text" id="postLink-<%= post.id %>" 
                   class="form-control border-primary-subtle"
                   value="<%= 'https://pethudl.com/posts/view-post/' + post.id %>" readonly>
            <button class="btn btn-outline-primary copy-link-btn" 
                    data-post-id="<%= post.id %>" type="button">
              <i class="fas fa-copy me-1"></i> Copy
            </button>
          </div>
        </div>

        <!-- Social Buttons -->
        <div class="d-flex flex-wrap gap-2 justify-content-center">
          <a href="https://www.instagram.com/" 
             target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
             style="background:#e4405f; color:#fff;" 
             title="Instagram doesn‚Äôt allow direct link sharing. Copy the link manually.">
            <i class="fab fa-instagram me-2"></i> Instagram
          </a>

          <a href="https://www.facebook.com/sharer/sharer.php?u=<%= encodeURIComponent('https://pethudl.com/posts/view-post/' + post.id) %>" 
            target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
             style="background:#1877f2; color:#fff;">
            <i class="fab fa-facebook-f me-2"></i> Facebook
          </a>
          
          <a href="https://x.com/intent/tweet?url=<%= encodeURIComponent('https://pethudl.com/posts/view-post/' + post.id) %>&text=<%= encodeURIComponent('Check this out!') %>" 
            target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
            style="background:#000; color:#fff;">
            <i class="fab fa-x-twitter me-2"></i> X
          </a>
          
          <a href="https://www.tiktok.com/share/video?url=<%= encodeURIComponent('https://pethudl.com/posts/view-post/' + post.id) %>" 
             target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
             style="background:#000000; color:#fff;">
            <i class="fab fa-tiktok me-2"></i> TikTok
          </a>
          
          <a href="https://www.youtube.com/" 
             target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
             style="background:#ff0000; color:#fff;" 
             title="YouTube doesn‚Äôt allow direct post sharing. Copy the link manually.">
            <i class="fab fa-youtube me-2"></i> YouTube
          </a>

          <a href="https://wa.me/?text=<%= encodeURIComponent('Check this out: https://pethudl.com/posts/view-post/' + post.id) %>" 
             target="_blank" class="btn btn-sm d-flex align-items-center px-3" 
             style="background:#25d366; color:#fff;">
            <i class="fab fa-whatsapp me-2"></i> WhatsApp
          </a>
        </div>

        <!-- Info -->
        <div class="alert alert-info small mt-4 mb-0">
          <i class="fas fa-info-circle me-1"></i>
          Instagram & YouTube don‚Äôt support direct web sharing. Copy the link and paste it manually in their apps.
        </div>
      </div>

    </div>
  </div>
</div>

  <% }) %>
<% } else { %>
  <p class="text-center text-muted mt-3">No posts yet</p>
<% } %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  
  // Like Button Handler
  document.querySelectorAll('.like-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const card = btn.closest('[data-post-id]');
      const postId = card.dataset.postId;
      
      try {
        const res = await fetch(`/posts/${postId}/like`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
          const countEl = card.querySelector('.likes-count');
          let currentLikes = parseInt(countEl.textContent) || 0;
          
          if (data.liked) {
            currentLikes++;
            btn.querySelector('i').classList.remove('far');
            btn.querySelector('i').classList.add('fas', 'text-primary');
          } else {
            currentLikes--;
            btn.querySelector('i').classList.remove('fas', 'text-primary');
            btn.querySelector('i').classList.add('far');
          }
          
          countEl.textContent = `${currentLikes} Likes`;
        }
      } catch (err) {
        console.error('Error liking post:', err);
      }
    });
  });

  // Load Comments Function
  async function loadComments(postId) {
    const listEl = document.getElementById(`comments-list-${postId}`);
    listEl.innerHTML = '<p class="text-muted">Loading comments...</p>';
    
    try {
      const res = await fetch(`/posts/${postId}/comments`);
      const data = await res.json();
      const comments = Array.isArray(data.comments) ? data.comments : [];
      
      if (comments.length > 0) {
        listEl.innerHTML = comments.map(c => `
          <div class="d-flex mb-2 align-items-start">
            <a href="/@${c.username}">
              <img src="${c.profile_pic || '/images/paw.jpg'}" 
                   class="rounded-circle border me-2" 
                   style="width:40px; height:40px; object-fit:cover;">
            </a>
            <div class="flex-fill">
              <div class="d-flex flex-column bg-light rounded-4 p-2">
                <p class="m-0 fw-bold small">@${c.username}</p>
                <p class="m-0 small">${c.comment}</p>
              </div>
              <div class="d-flex align-items-center gap-1">
                <span class="text-muted small">
                  <small>${new Date(c.created_at).toLocaleString()}</small>
                </span>
                ${c.can_delete ? 
                  `<a href="#" class="text-decoration-none text-muted delete-comment small fw-bold" 
                      data-comment-id="${c.id}" data-post-id="${postId}">
                     <span class="small">Delete</span>
                   </a>` : ''
                }
              </div>
            </div>
          </div>
        `).join('');
      } else {
        listEl.innerHTML = '<p class="text-muted">No comments yet</p>';
      }
    } catch (err) {
      console.error('Error loading comments:', err);
    }
  }

  // Comment Button Handler
  document.querySelectorAll('.comment-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const postId = btn.closest('[data-post-id]').dataset.postId;
      loadComments(postId);
    });
  });

  // Add Comment Handler
  document.querySelectorAll('.add-comment-form').forEach(form => {
    form.addEventListener('submit', async e => {
      e.preventDefault();
      const postId = form.dataset.postId;
      const input = form.querySelector('input[name="comment"]');
      const comment = input.value.trim();
      
      if (!comment) return;

      try {
        const res = await fetch(`/posts/${postId}/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment })
        });
        const data = await res.json();
        
        if (data.success) {
          input.value = '';
          loadComments(postId);
        }
      } catch (err) {
        console.error('Error adding comment:', err);
      }
    });
  });

  // Delete Comment Handler (Event Delegation)
  document.body.addEventListener('click', async (e) => {
    const btn = e.target.closest('.delete-comment');
    if (!btn) return;

    e.preventDefault();

    const commentId = btn.dataset.commentId;
    const postId = btn.dataset.postId;
    
    if (!commentId || !postId) return;
    if (!confirm('Delete this comment?')) return;

    try {
      const res = await fetch(`/posts/comment/${encodeURIComponent(commentId)}?postId=${encodeURIComponent(postId)}`, { 
        method: 'DELETE', 
        headers: { 'Accept': 'application/json' } 
      });
      const data = await res.json();

      if (data.success) {
        loadComments(postId);

        const postCard = document.querySelector(`[data-post-id="${postId}"]`);
        if (postCard) {
          const countEl = postCard.querySelector('.comment-count');
          if (countEl) {
            let current = parseInt(countEl.textContent, 10) || 0;
            current = Math.max(0, current - 1);
            countEl.textContent = `${current} Comments`;
          }
        }
      } else {
        alert(data.message || 'Failed to delete comment');
      }
    } catch (err) {
      console.error('Error deleting comment:', err);
      alert('Error deleting comment');
    }
  });

    // COPY LINK
document.body.addEventListener('click', e => {
  const btn = e.target.closest('.copy-link-btn');
  if (!btn) return;

  const postId = btn.dataset.postId;
  const input = document.getElementById(`postLink-${postId}`);

  input.select();
  input.setSelectionRange(0, 99999); // for mobile
  navigator.clipboard.writeText(input.value);

  btn.textContent = "Copied!";
  setTimeout(() => btn.textContent = "Copy", 2000);
});
});
</script>

<% if (user.id === profileUser.id) { %>
<script>
  // Delete Post Handler (Event Delegation)
  document.body.addEventListener('click', async e => {
    // Change from ID to class selector
    if (e.target.closest('.delete-post-btn')) {
      e.preventDefault();
      const btn = e.target.closest('.delete-post-btn');
      const postCard = btn.closest('[data-post-id]');
      const postId = postCard.dataset.postId;

      if (!confirm('üóëÔ∏è Are you sure you want to delete this post?')) return;

      try {
        const res = await fetch(`/posts/delete/${postId}`, { method: 'DELETE' });
        const data = await res.json();
        
        if (data.success) {
          // Add debugging to see if element exists
          console.log('Removing post card:', postCard);
          postCard.remove();
        } else {
          alert(data.message || 'Failed to delete post');
        }
      } catch (err) {
        console.error('Error deleting post:', err);
        alert('Error deleting post');
      }
    }
  });
</script>
<% } %>